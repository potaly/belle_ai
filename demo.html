<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å¯¼è´­æ‰§è¡ŒåŠ©æ‰‹ Demo - å»ºè®®ç³»ç»Ÿè¯•è¿è¡Œ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è‡ªå®šä¹‰æ ·å¼ */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-banner {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- ä½¿ç”¨æç¤º -->
        <div id="corsWarning" class="mb-4 p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded hidden">
            <div class="flex items-center">
                <span class="text-yellow-700 text-sm">
                    âš ï¸ æ£€æµ‹åˆ°è·¨åŸŸé—®é¢˜ï¼è¯·ä½¿ç”¨æœ¬åœ° HTTP æœåŠ¡å™¨è¿è¡Œï¼š<code class="bg-yellow-100 px-2 py-1 rounded">python start_demo_server.py</code>
                </span>
                <button onclick="document.getElementById('corsWarning').classList.add('hidden')" class="ml-auto text-yellow-500 hover:text-yellow-700">Ã—</button>
            </div>
        </div>
        
        <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">AI å¯¼è´­æ‰§è¡ŒåŠ©æ‰‹ Demo</h1>
            <div class="flex gap-2">
                <!-- æ¨¡æ‹Ÿæ•°æ®å¡«å……æŒ‰é’® -->
                <button 
                    onclick="fillMockData()" 
                    class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition text-sm"
                >
                    ğŸ“‹ æ¨¡æ‹Ÿæ•°æ®å¡«å……
                </button>
                <!-- è§†å›¾åˆ‡æ¢å¼€å…³ -->
                <label class="flex items-center gap-2 px-4 py-2 bg-gray-100 rounded-lg cursor-pointer">
                    <input type="checkbox" id="techViewToggle" onchange="toggleTechView()" class="w-4 h-4">
                    <span class="text-sm text-gray-700">æŠ€æœ¯è§†å›¾</span>
                </label>
            </div>
        </div>
        <p class="text-gray-600 mb-8">å»ºè®®ç³»ç»Ÿè¯•è¿è¡Œ</p>

        <!-- é”™è¯¯æç¤ºæ¡ -->
        <div id="errorBanner" class="hidden error-banner mb-4 p-4 bg-red-50 border-l-4 border-red-500 rounded">
            <div class="flex items-center">
                <span class="text-red-700 font-medium" id="errorMessage"></span>
                <button onclick="hideError()" class="ml-auto text-red-500 hover:text-red-700">Ã—</button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- ============================================
                 A. AI é”€å”®å»ºè®®ï¼ˆæœ‰è¡Œä¸ºæ•°æ®ï¼‰
                 ============================================ -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">AI é”€å”®å»ºè®®ï¼ˆæœ‰è¡Œä¸ºæ•°æ®ï¼‰</h2>
                
                <!-- è¡¨å•åŒº -->
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ç”¨æˆ· ID</label>
                        <input 
                            type="text" 
                            id="userId" 
                            value="user_002" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="è¾“å…¥ç”¨æˆ· ID"
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å•†å“ SKU</label>
                        <input 
                            type="text" 
                            id="sku" 
                            value="8WZ12CM2" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="è¾“å…¥å•†å“ SKU"
                        >
                    </div>
                    <div class="flex items-center gap-2">
                        <input 
                            type="checkbox" 
                            id="useCustomPlan" 
                            class="w-4 h-4"
                        >
                        <label for="useCustomPlan" class="text-sm text-gray-700">ä½¿ç”¨è‡ªå®šä¹‰è®¡åˆ’</label>
                    </div>
                    <button 
                        onclick="getSalesSuggestion()" 
                        id="salesBtn"
                        class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium"
                    >
                        <span id="salesBtnText">è·å– AI å»ºè®®</span>
                        <span id="salesBtnLoading" class="hidden inline-block ml-2">
                            <div class="loading-spinner"></div>
                        </span>
                    </button>
                </div>

                <!-- å±•ç¤ºåŒº -->
                <div id="salesResult" class="hidden">
                    <!-- çŠ¶æ€æ ‡ç­¾ -->
                    <div class="mb-4">
                        <div id="statusBadge" class="inline-block px-3 py-1 rounded-full text-sm font-medium"></div>
                        <div id="antiDisturbBadge" class="hidden inline-block ml-2 px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                            âš ï¸ è§¦è¾¾å·²è¢«åæ‰“æ‰°æ‹¦æˆª
                        </div>
                    </div>

                    <!-- æ¨èè¯æœ¯ -->
                    <div class="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <p class="text-sm text-gray-600 mb-1">æ¨èè¯æœ¯</p>
                                <p id="primaryMessage" class="text-gray-800 font-medium"></p>
                            </div>
                            <button 
                                onclick="copyToClipboard('primaryMessage')" 
                                class="ml-2 px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition text-sm"
                            >
                                å¤åˆ¶
                            </button>
                        </div>
                    </div>

                    <!-- ä¸ºä»€ä¹ˆè¿™ä¹ˆå»ºè®® -->
                    <div class="mb-4">
                        <p class="text-sm font-medium text-gray-700 mb-2">ä¸ºä»€ä¹ˆè¿™ä¹ˆå»ºè®®</p>
                        <ul id="decisionReasons" class="list-disc list-inside space-y-1 text-sm text-gray-600"></ul>
                    </div>

                    <!-- æ›´å¤šå‚è€ƒè¯æœ¯ï¼ˆæŠ˜å é¢æ¿ï¼‰ -->
                    <div class="mb-4">
                        <button 
                            onclick="toggleAlternatives()" 
                            class="flex items-center justify-between w-full px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition"
                        >
                            <span class="text-sm font-medium text-gray-700">æ›´å¤šå‚è€ƒè¯æœ¯</span>
                            <span id="alternativesToggle" class="text-gray-500">â–¼</span>
                        </button>
                        <div id="alternativesPanel" class="hidden mt-2 space-y-2">
                            <div id="alternativesList"></div>
                        </div>
                    </div>

                    <!-- è·Ÿè¿› SOP -->
                    <div id="followupSOP" class="hidden mb-4">
                        <p class="text-sm font-medium text-gray-700 mb-2">è·Ÿè¿› SOP</p>
                        <div id="followupList" class="space-y-2"></div>
                    </div>

                    <!-- é¡µè„šï¼šè€—æ—¶ -->
                    <div class="text-xs text-gray-500 text-right">
                        è€—æ—¶: <span id="executionTime"></span> ç§’
                    </div>

                    <!-- æŠ€æœ¯è§†å›¾ï¼šåŸå§‹ JSON -->
                    <div id="techViewSales" class="hidden mt-4 p-4 bg-gray-50 rounded-lg">
                        <p class="text-xs font-mono text-gray-600 whitespace-pre-wrap" id="techViewSalesContent"></p>
                    </div>
                </div>
            </div>

            <!-- ============================================
                 B. å•†å“ç§èŠè¯æœ¯ï¼ˆæ— è¡Œä¸ºæ•°æ®ï¼‰
                 ============================================ -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">å•†å“ç§èŠè¯æœ¯ï¼ˆæ— è¡Œä¸ºæ•°æ®ï¼‰</h2>
                
                <!-- è¡¨å•åŒº -->
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å•†å“ SKU</label>
                        <input 
                            type="text" 
                            id="copySku" 
                            value="8WZ01CM1" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="è¾“å…¥å•†å“ SKU"
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">è¯æœ¯é£æ ¼</label>
                        <select 
                            id="copyStyle" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                            <option value="natural">è‡ªç„¶</option>
                            <option value="professional">ä¸“ä¸š</option>
                            <option value="friendly">å‹å¥½</option>
                        </select>
                    </div>
                    <button 
                        onclick="generateCopy()" 
                        id="copyBtn"
                        class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium"
                    >
                        <span id="copyBtnText">ç”Ÿæˆç§èŠè¯æœ¯</span>
                        <span id="copyBtnLoading" class="hidden inline-block ml-2">
                            <div class="loading-spinner"></div>
                        </span>
                    </button>
                </div>

                <!-- å±•ç¤ºåŒº -->
                <div id="copyResult" class="hidden">
                    <!-- å•†å“å -->
                    <div class="mb-4">
                        <p class="text-sm text-gray-600 mb-1">å•†å“åç§°</p>
                        <p id="productName" class="text-lg font-semibold text-gray-800"></p>
                    </div>

                    <!-- å–ç‚¹æ ‡ç­¾ -->
                    <div class="mb-4">
                        <p class="text-sm text-gray-600 mb-2">å•†å“å–ç‚¹</p>
                        <div id="sellingPoints" class="flex flex-wrap gap-2"></div>
                    </div>

                    <!-- å€™é€‰è¯æœ¯ -->
                    <div>
                        <p class="text-sm font-medium text-gray-700 mb-2">å€™é€‰è¯æœ¯</p>
                        <div id="copyCandidates" class="space-y-3"></div>
                    </div>

                    <!-- æŠ€æœ¯è§†å›¾ï¼šåŸå§‹ JSON -->
                    <div id="techViewCopy" class="hidden mt-4 p-4 bg-gray-50 rounded-lg">
                        <p class="text-xs font-mono text-gray-600 whitespace-pre-wrap" id="techViewCopyContent"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast æç¤º -->
    <div id="toast" class="hidden toast">
        <div class="bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg">
            <span id="toastMessage">å·²å¤åˆ¶</span>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8000';

        // ============================================
        // å·¥å…·å‡½æ•°
        // ============================================

        /**
         * æ˜¾ç¤ºé”™è¯¯æç¤º
         */
        function showError(message) {
            const banner = document.getElementById('errorBanner');
            const messageEl = document.getElementById('errorMessage');
            messageEl.textContent = message;
            banner.classList.remove('hidden');
        }

        /**
         * éšè—é”™è¯¯æç¤º
         */
        function hideError() {
            document.getElementById('errorBanner').classList.add('hidden');
        }

        /**
         * æ˜¾ç¤º Toast æç¤º
         */
        function showToast(message = 'å·²å¤åˆ¶') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 2000);
        }

        /**
         * å¤åˆ¶åˆ°å‰ªè´´æ¿
         */
        async function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent.trim();
            try {
                await navigator.clipboard.writeText(text);
                showToast('å·²å¤åˆ¶');
            } catch (err) {
                showError('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            }
        }

        /**
         * å¤åˆ¶æŒ‡å®šæ–‡æœ¬
         */
        async function copyText(text) {
            try {
                await navigator.clipboard.writeText(text);
                showToast('å·²å¤åˆ¶');
            } catch (err) {
                showError('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            }
        }

        /**
         * è®¾ç½®åŠ è½½çŠ¶æ€
         */
        function setLoading(buttonId, isLoading) {
            const btn = document.getElementById(buttonId);
            const btnText = document.getElementById(buttonId + 'Text');
            const btnLoading = document.getElementById(buttonId + 'Loading');
            
            if (isLoading) {
                btn.disabled = true;
                btn.classList.add('opacity-75', 'cursor-not-allowed');
                btnText.classList.add('hidden');
                btnLoading.classList.remove('hidden');
            } else {
                btn.disabled = false;
                btn.classList.remove('opacity-75', 'cursor-not-allowed');
                btnText.classList.remove('hidden');
                btnLoading.classList.add('hidden');
            }
        }

        /**
         * åˆ‡æ¢æŠ€æœ¯è§†å›¾
         */
        function toggleTechView() {
            const isTechView = document.getElementById('techViewToggle').checked;
            document.getElementById('techViewSales').classList.toggle('hidden', !isTechView);
            document.getElementById('techViewCopy').classList.toggle('hidden', !isTechView);
        }

        /**
         * æ¨¡æ‹Ÿæ•°æ®å¡«å……
         */
        function fillMockData() {
            // å¡«å……é”€å”®å»ºè®®è¡¨å•
            document.getElementById('userId').value = 'user_002';
            document.getElementById('sku').value = '8WZ12CM2';
            document.getElementById('useCustomPlan').checked = false;
            
            // å¡«å……å•†å“è¯æœ¯è¡¨å•
            document.getElementById('copySku').value = '8WZ01CM1';
            document.getElementById('copyStyle').value = 'natural';
            
            showToast('å·²å¡«å……æ¨¡æ‹Ÿæ•°æ®');
        }

        /**
         * åˆ‡æ¢æ›´å¤šå‚è€ƒè¯æœ¯é¢æ¿
         */
        function toggleAlternatives() {
            const panel = document.getElementById('alternativesPanel');
            const toggle = document.getElementById('alternativesToggle');
            const isHidden = panel.classList.contains('hidden');
            
            panel.classList.toggle('hidden', !isHidden);
            toggle.textContent = isHidden ? 'â–²' : 'â–¼';
        }

        /**
         * å¤„ç†å†³ç­–åŸå› ï¼ˆæ‹†åˆ†æˆ bullet pointsï¼‰
         */
        function formatDecisionReason(reason) {
            if (!reason) return [];
            
            // æŒ‰åˆ†å·ã€å¥å·ã€æ¢è¡Œç¬¦åˆ†å‰²
            const parts = reason.split(/[ï¼›ã€‚\n]/).filter(p => p.trim());
            
            // å¦‚æœåˆ†å‰²ååªæœ‰ä¸€æ¡ï¼Œå°è¯•æŒ‰é€—å·åˆ†å‰²
            if (parts.length === 1) {
                const commaParts = reason.split(/ï¼Œ/).filter(p => p.trim());
                return commaParts.length > 1 ? commaParts : parts;
            }
            
            return parts;
        }

        // ============================================
        // A. AI é”€å”®å»ºè®®
        // ============================================

        /**
         * æ£€æµ‹æ˜¯å¦ä½¿ç”¨ file:// åè®®ï¼ˆä¼šæœ‰è·¨åŸŸé—®é¢˜ï¼‰
         */
        function checkCorsIssue() {
            if (window.location.protocol === 'file:') {
                document.getElementById('corsWarning').classList.remove('hidden');
            }
        }

        /**
         * è·å– AI é”€å”®å»ºè®®
         */
        async function getSalesSuggestion() {
            hideError();
            setLoading('salesBtn', true);
            
            const userId = document.getElementById('userId').value.trim();
            const sku = document.getElementById('sku').value.trim();
            const useCustomPlan = document.getElementById('useCustomPlan').checked;
            
            if (!userId || !sku) {
                showError('è¯·å¡«å†™ç”¨æˆ· ID å’Œå•†å“ SKU');
                setLoading('salesBtn', false);
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/ai/sales/graph`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        sku: sku,
                        use_custom_plan: useCustomPlan,
                    }),
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'è¯·æ±‚å¤±è´¥' }));
                    throw new Error(errorData.message || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.success || !data.data) {
                    throw new Error(data.message || 'è¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
                }
                
                displaySalesResult(data.data);
                
                // æŠ€æœ¯è§†å›¾ï¼šä¿å­˜åŸå§‹ JSON
                if (document.getElementById('techViewToggle').checked) {
                    document.getElementById('techViewSalesContent').textContent = JSON.stringify(data, null, 2);
                }
                
            } catch (error) {
                console.error('Error:', error);
                // æ›´è¯¦ç»†çš„é”™è¯¯è¯Šæ–­
                let errorMsg = `è¯·æ±‚å¤±è´¥: ${error.message}`;
                
                if (error.message.includes('Failed to fetch')) {
                    // å¯èƒ½æ˜¯ç½‘ç»œé”™è¯¯ã€CORS æˆ–åç«¯æœªè¿è¡Œ
                    errorMsg = `è¯·æ±‚å¤±è´¥ï¼šæ— æ³•è¿æ¥åˆ°åç«¯ API (${API_BASE})ã€‚è¯·æ£€æŸ¥ï¼š\n1. åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œåœ¨ http://127.0.0.1:8000\n2. åç«¯æ˜¯å¦é…ç½®äº† CORS å…è®¸è·¨åŸŸè¯·æ±‚`;
                } else if (error.message.includes('CORS')) {
                    errorMsg = 'è¯·æ±‚å¤±è´¥ï¼šè·¨åŸŸé—®é¢˜ã€‚è¯·ç¡®ä¿åç«¯é…ç½®äº† CORS å…è®¸è·¨åŸŸè¯·æ±‚';
                }
                
                showError(errorMsg);
            } finally {
                setLoading('salesBtn', false);
            }
        }

        /**
         * å±•ç¤ºé”€å”®å»ºè®®ç»“æœ
         */
        function displaySalesResult(data) {
            const resultDiv = document.getElementById('salesResult');
            resultDiv.classList.remove('hidden');
            
            // çŠ¶æ€æ ‡ç­¾
            const statusBadge = document.getElementById('statusBadge');
            const antiDisturbBadge = document.getElementById('antiDisturbBadge');
            
            if (data.allowed) {
                statusBadge.className = 'inline-block px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800';
                statusBadge.textContent = 'âœ“ AI å»ºè®®ï¼šå¯ä»¥è”ç³»å®¢æˆ·';
            } else {
                statusBadge.className = 'inline-block px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800';
                statusBadge.textContent = 'â—‹ AI å»ºè®®ï¼šæš‚ä¸è”ç³»å®¢æˆ·';
            }
            
            // åæ‰“æ‰°æ‹¦æˆªæç¤º
            if (data.anti_disturb_blocked) {
                antiDisturbBadge.classList.remove('hidden');
            } else {
                antiDisturbBadge.classList.add('hidden');
            }
            
            // æ¨èè¯æœ¯ï¼ˆä¼˜å…ˆä½¿ç”¨ final_messageï¼Œå¦åˆ™ä½¿ç”¨ message_pack primaryï¼‰
            const primaryMessage = data.final_message || 
                (data.sales_suggestion?.message_pack?.find(m => m.type === 'primary')?.message) ||
                'æš‚æ— æ¨èè¯æœ¯';
            document.getElementById('primaryMessage').textContent = primaryMessage;
            
            // ä¸ºä»€ä¹ˆè¿™ä¹ˆå»ºè®®
            const reasons = formatDecisionReason(data.decision_reason || '');
            const reasonsList = document.getElementById('decisionReasons');
            reasonsList.innerHTML = '';
            if (reasons.length > 0) {
                reasons.forEach(reason => {
                    const li = document.createElement('li');
                    li.textContent = reason.trim();
                    reasonsList.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.textContent = 'æš‚æ— åŸå› è¯´æ˜';
                reasonsList.appendChild(li);
            }
            
            // æ›´å¤šå‚è€ƒè¯æœ¯
            const alternatives = data.sales_suggestion?.message_pack?.filter(m => m.type === 'alternative') || [];
            const alternativesList = document.getElementById('alternativesList');
            alternativesList.innerHTML = '';
            
            if (alternatives.length > 0) {
                alternatives.slice(0, 2).forEach((alt, index) => {
                    const div = document.createElement('div');
                    div.className = 'p-3 bg-gray-50 rounded-lg border border-gray-200';
                    div.innerHTML = `
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <p class="text-xs text-gray-500 mb-1">å¤‡é€‰ ${index + 1}</p>
                                <p class="text-sm text-gray-800">${alt.message}</p>
                            </div>
                            <button 
                                onclick="copyText('${alt.message.replace(/'/g, "\\'")}')" 
                                class="ml-2 px-2 py-1 bg-gray-600 text-white rounded hover:bg-gray-700 transition text-xs"
                            >
                                å¤åˆ¶
                            </button>
                        </div>
                    `;
                    alternativesList.appendChild(div);
                });
            } else {
                alternativesList.innerHTML = '<p class="text-sm text-gray-500">æš‚æ— æ›´å¤šå‚è€ƒè¯æœ¯</p>';
            }
            
            // è·Ÿè¿› SOP
            const followupSOP = document.getElementById('followupSOP');
            const followupList = document.getElementById('followupList');
            followupList.innerHTML = '';
            
            const playbook = data.sales_suggestion?.followup_playbook || [];
            if (playbook.length > 0) {
                followupSOP.classList.remove('hidden');
                playbook.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'p-3 bg-blue-50 rounded-lg border border-blue-200';
                    div.innerHTML = `
                        <div class="mb-2">
                            <span class="text-xs font-medium text-blue-700">å¦‚æœï¼š</span>
                            <span class="text-sm text-gray-800">${item.condition}</span>
                        </div>
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <span class="text-xs font-medium text-blue-700">å›å¤ï¼š</span>
                                <span class="text-sm text-gray-800">${item.reply}</span>
                            </div>
                            <button 
                                onclick="copyText('${item.reply.replace(/'/g, "\\'")}')" 
                                class="ml-2 px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition text-xs"
                            >
                                å¤åˆ¶
                            </button>
                        </div>
                    `;
                    followupList.appendChild(div);
                });
            } else {
                followupSOP.classList.add('hidden');
            }
            
            // è€—æ—¶
            const executionTime = data.execution_time_seconds || 0;
            document.getElementById('executionTime').textContent = executionTime.toFixed(2);
        }

        // ============================================
        // B. å•†å“ç§èŠè¯æœ¯
        // ============================================

        /**
         * ç”Ÿæˆå•†å“ç§èŠè¯æœ¯
         */
        async function generateCopy() {
            hideError();
            setLoading('copyBtn', true);
            
            const sku = document.getElementById('copySku').value.trim();
            const style = document.getElementById('copyStyle').value;
            
            if (!sku) {
                showError('è¯·å¡«å†™å•†å“ SKU');
                setLoading('copyBtn', false);
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/ai/generate/copy`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sku: sku,
                        style: style,
                        scene: 'guide_chat',
                        character_limit: 45,
                    }),
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'è¯·æ±‚å¤±è´¥' }));
                    throw new Error(errorData.message || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                displayCopyResult(data);
                
                // æŠ€æœ¯è§†å›¾ï¼šä¿å­˜åŸå§‹ JSON
                if (document.getElementById('techViewToggle').checked) {
                    document.getElementById('techViewCopyContent').textContent = JSON.stringify(data, null, 2);
                }
                
            } catch (error) {
                console.error('Error:', error);
                // æ›´è¯¦ç»†çš„é”™è¯¯è¯Šæ–­
                let errorMsg = `è¯·æ±‚å¤±è´¥: ${error.message}`;
                
                if (error.message.includes('Failed to fetch')) {
                    // å¯èƒ½æ˜¯ç½‘ç»œé”™è¯¯ã€CORS æˆ–åç«¯æœªè¿è¡Œ
                    errorMsg = `è¯·æ±‚å¤±è´¥ï¼šæ— æ³•è¿æ¥åˆ°åç«¯ API (${API_BASE})ã€‚è¯·æ£€æŸ¥ï¼š\n1. åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œåœ¨ http://127.0.0.1:8000\n2. åç«¯æ˜¯å¦é…ç½®äº† CORS å…è®¸è·¨åŸŸè¯·æ±‚`;
                } else if (error.message.includes('CORS')) {
                    errorMsg = 'è¯·æ±‚å¤±è´¥ï¼šè·¨åŸŸé—®é¢˜ã€‚è¯·ç¡®ä¿åç«¯é…ç½®äº† CORS å…è®¸è·¨åŸŸè¯·æ±‚';
                }
                
                showError(errorMsg);
            } finally {
                setLoading('copyBtn', false);
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æµ‹è·¨åŸŸé—®é¢˜
        window.addEventListener('DOMContentLoaded', checkCorsIssue);

        /**
         * å±•ç¤ºå•†å“è¯æœ¯ç»“æœ
         */
        function displayCopyResult(data) {
            const resultDiv = document.getElementById('copyResult');
            resultDiv.classList.remove('hidden');
            
            // å•†å“å
            document.getElementById('productName').textContent = data.product_name || 'æœªçŸ¥å•†å“';
            
            // å–ç‚¹æ ‡ç­¾
            const sellingPointsDiv = document.getElementById('sellingPoints');
            sellingPointsDiv.innerHTML = '';
            const sellingPoints = data.selling_points || [];
            if (sellingPoints.length > 0) {
                sellingPoints.forEach(point => {
                    const span = document.createElement('span');
                    span.className = 'px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs';
                    span.textContent = point;
                    sellingPointsDiv.appendChild(span);
                });
            } else {
                sellingPointsDiv.innerHTML = '<span class="text-sm text-gray-500">æš‚æ— å–ç‚¹</span>';
            }
            
            // å€™é€‰è¯æœ¯
            const candidatesDiv = document.getElementById('copyCandidates');
            candidatesDiv.innerHTML = '';
            const candidates = data.copy_candidates || [];
            
            if (candidates.length > 0) {
                candidates.forEach((candidate, index) => {
                    const div = document.createElement('div');
                    div.className = 'p-4 bg-green-50 rounded-lg border border-green-200';
                    div.innerHTML = `
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <p class="text-xs text-gray-500 mb-1">å€™é€‰ ${index + 1}</p>
                                <p class="text-sm text-gray-800">${candidate.message}</p>
                            </div>
                            <button 
                                onclick="copyText('${candidate.message.replace(/'/g, "\\'")}')" 
                                class="ml-2 px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition text-sm"
                            >
                                å¤åˆ¶
                            </button>
                        </div>
                    `;
                    candidatesDiv.appendChild(div);
                });
            } else {
                candidatesDiv.innerHTML = '<p class="text-sm text-gray-500">æš‚æ— å€™é€‰è¯æœ¯</p>';
            }
        }
    </script>
</body>
</html>

