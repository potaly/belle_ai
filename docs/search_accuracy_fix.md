# 搜索精确度问题分析和修复

## 问题分析

从日志和搜索结果看，存在以下问题：

### 1. 搜索时 API 调用失败
**现象**：
- 初始化时 API 调用成功（所有批次都返回 200 OK）
- 搜索时 API 调用失败，使用了 stub embeddings

**影响**：
- 查询向量和索引向量不匹配（索引用真实 API，查询用 stub）
- 导致距离分数异常（所有 score 都在 1.92-1.94 之间，相似度很低）

**原因**：
- 可能是搜索时的 API 调用有错误（需要查看详细错误日志）
- 或者 API Key/URL 配置有问题

### 2. 商品名称信息丢失
**现象**：
- 搜索"运动鞋"，返回的结果都是"这是一款白色的鞋子"
- 没有包含"运动鞋"关键词，导致关键词匹配失败

**原因**：
- `_product_to_natural_language` 函数在提取到类型后，只生成"这是一款{product_type}"
- 如果商品名称是"运动鞋女2024新款时尚"，提取到类型"运动鞋"，生成的文本是"这是一款黑色的运动鞋"，这是对的
- 但如果商品名称中没有"运动鞋"这个词（如"鞋子女2024新款"），就提取不到类型，生成的文本就是"这是一款白色的鞋子"，丢失了原始名称

### 3. 关键词匹配失败
**现象**：
- 日志显示"前3个结果的关键词分数 = ['-10.0', '-10.0', '-10.0']"
- 所有结果都没有匹配到"运动鞋"类型

**原因**：
- Chunk 中没有"运动鞋"这个词
- 关键词匹配逻辑正确，但数据中缺少关键词

## 修复方案

### 1. 确保商品名称被包含
- 修改 `_product_to_natural_language` 函数
- 即使已经用类型描述了，也要包含完整商品名称
- 这样即使类型提取失败，也能通过名称匹配

### 2. 增强错误日志
- 记录更详细的 API 错误信息
- 包括错误响应内容，便于排查

### 3. 检查 API 调用
- 确保搜索时和初始化时使用相同的 API 配置
- 检查是否有网络或认证问题

## 测试建议

1. **重新构建索引**（包含商品名称）：
   ```bash
   python app/db/init_vector_store.py
   ```

2. **检查搜索时的 API 调用**：
   - 查看日志中的详细错误信息
   - 确认 API Key 和 URL 配置正确

3. **测试搜索**：
   ```bash
   POST http://127.0.0.1:8000/ai/vector/search
   {
       "query": "运动鞋",
       "top_k": 5
   }
   ```

4. **预期结果**：
   - 返回的商品应该包含"运动鞋"关键词
   - 关键词匹配分数应该 > 0
   - 距离分数应该 < 1.5（相似度高）

