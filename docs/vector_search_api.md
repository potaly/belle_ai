# 向量搜索 API 接口文档

## 概述

向量搜索 API 是 V2 版本的核心功能，提供基于语义相似度的商品搜索能力。通过阿里百炼嵌入模型和 FAISS 向量数据库，实现智能的商品检索。

## 功能特点

- ✅ **语义搜索**：理解用户意图，而非简单的关键词匹配
- ✅ **智能推荐**：根据商品特征自动匹配相关商品
- ✅ **快速响应**：基于 FAISS 向量索引，毫秒级响应
- ✅ **中文优化**：使用阿里百炼 `text-embedding-v2` 模型，对中文支持优秀

## API 接口

### 1. 向量搜索接口

**接口地址**: `POST /ai/vector/search`

**功能说明**：
根据用户输入的查询文本，在商品知识库中搜索语义相似的商品信息。

**请求示例**：

```bash
curl -X POST "http://127.0.0.1:8000/ai/vector/search" \
  -H "Content-Type: application/json" \
  -d '{
    "query": "舒适的运动鞋",
    "top_k": 5
  }'
```

**请求参数**：

| 参数 | 类型 | 必填 | 说明 | 示例 |
|------|------|------|------|------|
| query | string | 是 | 搜索查询文本 | "舒适的运动鞋" |
| top_k | integer | 否 | 返回结果数量，范围1-20，默认5 | 5 |

**响应示例**：

```json
{
  "code": 200,
  "message": "搜索成功",
  "data": {
    "query": "舒适的运动鞋",
    "total": 5,
    "results": [
      {
        "rank": 1,
        "score": 0.8769,
        "chunk": "[商品：运动鞋女2024新款时尚（SKU：8WZ01CM1）] 商品名称：运动鞋女2024新款时尚。商品SKU：8WZ01CM1。商品描述：这是一双专为女性设计的运动鞋，采用真皮材质，黑色经典配色，适合四季穿着，适合运动场景。商品标签：百搭、舒适、时尚..."
      },
      {
        "rank": 2,
        "score": 1.1777,
        "chunk": "[商品：高跟鞋女2024新款优雅（SKU：8WZ03CM3）] 商品名称：高跟鞋女2024新款优雅..."
      }
    ]
  }
}
```

**响应字段说明**：

| 字段 | 类型 | 说明 |
|------|------|------|
| query | string | 原始查询文本 |
| total | integer | 结果总数 |
| results | array | 搜索结果列表 |
| results[].rank | integer | 结果排名（从1开始） |
| results[].score | float | 相似度分数（L2距离），越小表示越相似 |
| results[].chunk | string | 匹配的商品文本块内容 |

**相似度分数说明**：
- 分数范围：0 到正无穷
- 分数越小，表示越相似
- 通常相似的商品分数在 0.5-1.5 之间
- 完全不相关的商品分数可能 > 2.0

### 2. 索引统计接口

**接口地址**: `GET /ai/vector/stats`

**功能说明**：
获取向量索引的统计信息，用于监控和调试。

**请求示例**：

```bash
curl "http://127.0.0.1:8000/ai/vector/stats"
```

**响应示例**：

```json
{
  "code": 200,
  "message": "获取统计信息成功",
  "data": {
    "loaded": true,
    "num_vectors": 150,
    "dimension": 1536,
    "num_chunks": 150
  }
}
```

**响应字段说明**：

| 字段 | 类型 | 说明 |
|------|------|------|
| loaded | boolean | 索引是否已加载 |
| num_vectors | integer | 向量数量 |
| dimension | integer | 向量维度（通常是1536） |
| num_chunks | integer | 文本块数量 |

## 使用场景

### 场景 1: 商品推荐

**需求**：用户想要"舒适的运动鞋"

**请求**：
```json
{
  "query": "舒适的运动鞋",
  "top_k": 10
}
```

**结果**：返回最相关的10个商品，按相似度排序

### 场景 2: 导购助手

**需求**：导购人员输入商品特征，快速找到匹配商品

**请求**：
```json
{
  "query": "适合通勤的黑色真皮鞋",
  "top_k": 5
}
```

**结果**：返回匹配的商品信息，帮助导购快速定位

### 场景 3: 智能问答

**需求**：用户询问"有什么适合跑步的鞋子？"

**请求**：
```json
{
  "query": "适合跑步的鞋子",
  "top_k": 5
}
```

**结果**：返回相关的商品信息，可用于构建回答

## 技术实现

### 工作流程

1. **接收查询**：API 接收用户输入的查询文本
2. **生成嵌入**：调用阿里百炼 API，将查询文本转换为 1536 维向量
3. **向量搜索**：在 FAISS 索引中搜索最相似的向量（使用 L2 距离）
4. **结果排序**：按相似度分数排序
5. **返回结果**：返回前 top_k 个最相似的商品文本块

### 技术栈

- **嵌入模型**：阿里百炼 `text-embedding-v2`（1536维）
- **向量数据库**：FAISS IndexFlatL2（精确搜索）
- **距离度量**：L2（欧氏距离）
- **向量归一化**：L2 归一化

### 性能指标

- **搜索延迟**：通常 < 100ms（包括嵌入生成）
- **索引大小**：每个向量约 6KB（1536维 × 4字节）
- **支持规模**：可支持数万到数十万商品

## 使用前准备

### 1. 初始化向量索引

在使用 API 之前，需要先初始化向量索引：

```bash
python app/db/init_vector_store.py
```

这会：
- 从 MySQL 加载所有商品数据
- 将商品文本分块
- 生成嵌入向量
- 构建 FAISS 索引
- 保存到 `./vector_store/faiss.index`

### 2. 检查索引状态

```bash
curl "http://127.0.0.1:8000/ai/vector/stats"
```

如果返回 `"loaded": false`，说明索引未初始化。

## 错误处理

### 错误 1: 索引未初始化

**错误信息**：
```json
{
  "detail": "向量索引未初始化，请先运行 python app/db/init_vector_store.py 初始化索引"
}
```

**解决方法**：
运行初始化脚本创建索引

### 错误 2: 查询为空

**错误信息**：
```json
{
  "detail": "查询文本不能为空"
}
```

**解决方法**：
提供有效的查询文本

### 错误 3: API 调用失败

**错误信息**：
```json
{
  "detail": "搜索失败: Embedding API call failed"
}
```

**解决方法**：
- 检查 `.env` 文件中的 API 配置
- 确认网络连接正常
- 查看日志了解详细错误信息

## 最佳实践

### 1. 查询文本优化

- ✅ **使用自然语言**："舒适的运动鞋" 比 "运动鞋 舒适" 更好
- ✅ **包含关键特征**："黑色真皮高跟鞋" 比 "高跟鞋" 更精确
- ✅ **避免过短**：至少 3-5 个字符

### 2. top_k 参数选择

- **推荐场景**：top_k = 10-20，给用户更多选择
- **精确匹配**：top_k = 3-5，只返回最相关的结果
- **性能考虑**：top_k 越大，响应时间可能略增

### 3. 结果处理

- **相似度阈值**：可以设置 score < 1.5 作为相关阈值
- **结果去重**：如果多个块来自同一商品，可以合并
- **结果排序**：已经按相似度排序，直接使用即可

## 与其他接口的配合

### 与商品分析接口配合

```python
# 1. 使用向量搜索找到相关商品
search_results = vector_search("舒适的运动鞋", top_k=5)

# 2. 提取商品 SKU
skus = extract_skus_from_chunks(search_results)

# 3. 调用商品分析接口获取详细信息
for sku in skus:
    analysis = analyze_product(sku)
    # 展示给用户
```

### 与文案生成接口配合

```python
# 1. 搜索相关商品
results = vector_search("时尚高跟鞋", top_k=3)

# 2. 为每个商品生成文案
for result in results:
    sku = extract_sku(result.chunk)
    copy = generate_copy(sku, style="natural")
    # 展示文案
```

## 常见问题

### Q1: 为什么搜索结果不准确？

**可能原因**：
1. 索引未更新：商品数据变化后未重新构建索引
2. 查询文本不清晰：使用更具体的描述
3. 商品数据质量：确保商品描述完整准确

**解决方法**：
- 定期重新构建索引
- 优化查询文本
- 完善商品数据

### Q2: 搜索速度慢怎么办？

**优化建议**：
1. 减少 top_k 参数
2. 使用更快的索引类型（如 IndexIVFFlat）
3. 优化网络连接（嵌入 API 调用）

### Q3: 如何更新索引？

**方法**：
1. 更新 MySQL 中的商品数据
2. 重新运行初始化脚本：
   ```bash
   python app/db/init_vector_store.py
   ```
3. 重启服务（索引会自动重新加载）

## 更新日志

- **2024-12-02**: 初始版本，支持基本的向量搜索功能
- 使用阿里百炼 `text-embedding-v2` 模型
- 支持 top_k 参数控制结果数量
- 提供索引统计接口

